# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Express.js service that generates PDFs from URLs or HTML strings using Puppeteer. Deployed to Scalingo via GitHub Actions.

## Core Architecture

### PDF Generation Flows

Two distinct PDF generation paths with separate browser instances:

1. **URL-based generation** (`/print` endpoint → `src/print.js`):

   - Uses singleton browser instance with lazy initialization
   - JavaScript disabled for security
   - Waits for network idle before rendering
   - Default margins: 1cm all sides

2. **HTML-based generation** (`/generate` endpoint → `src/generatePdfFromHtml.js`):
   - Uses shared browser instance initialized at server startup
   - Rate-limited to 1 concurrent request via Bottleneck
   - Request ID tracking for all operations
   - Default margins: 2.5cm top/bottom, 1.5cm left/right

### Key Files

- `src/server.js`: Express app setup, auth middleware, endpoint definitions
- `src/print.js`: URL→PDF with singleton browser pattern
- `src/generatePdfFromHtml.js`: HTML→PDF with concurrency control

## Development Commands

```bash
# Run server
npm start

# Lint and format
npm run format    # Auto-fix with Prettier and ESLint
npm run lint      # Check only
```

## Environment Variables

Required:

- `API_KEY`: Bearer token for Authorization header
- `PORT`: Server listen port

Optional:

- `PDF_NAVIGATION_TIMEOUT`: Timeout in ms for page.setContent() in /generate endpoint (default: 5000)

## Code Patterns

### Logging

Uses Pino for structured JSON logging. All logs include standard metadata (timestamp, level, hostname, pid).

**Logger instances:**

- Base logger (`src/logger.js`): Export for module-level logging
- pino-http middleware: Adds `req.log` to all requests with automatic request/response logging
- Child loggers: Created with `createRequestLogger(requestId)` or `logger.child({ context })`

**Structured log fields:**

- `requestId`: Trace requests end-to-end (auto-generated by pino-http)
- `endpoint`: `/print` or `/generate`
- `module`: Source module name
- `duration`: Operation timing in ms
- `err.type`, `err.message`, `err.stack`: Error details (via pino.stdSerializers.err)
- `htmlContentLength`: Length of HTML content (never log content itself)
- `urlDomain`, `urlPath`: Parsed URL components (never log full URLs with query params)
- `margins`: PDF margin settings

**Privacy:**

- Authorization headers redacted automatically
- HTML content never logged (only length)
- Full URLs sanitized (domain + path only)

### Margin Options

Both endpoints accept margin parameters. Extract with `getMarginOptions(queryParams)` which returns object with `top`, `right`, `bottom`, `left` properties.

### Temporary Files

Use `tmp.fileSync({ suffix: ".pdf" })` and always call `tmpFile.removeCallback()` in download callback or finally block.

## Deployment

Auto-deploys to Scalingo on push to `main` via `.github/workflows/deploy-to-scalingo.yml`.

Required GitHub secrets/variables:

- `SCALINGO_API_TOKEN`
- `APP_NAME`
- `REGION`
- `TARGZ_URL`
